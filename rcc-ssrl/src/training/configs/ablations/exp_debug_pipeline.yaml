# Smoke test for all SSL families (minimal epochs/steps)
experiment:
  name: exp_debug_pipeline_smoke
  date: '2025-11-08'
  seed: 1337
  default_run_index: -1          # <-- parte il primo run (DINOv3)
  paper_tags: [ssl, histopathology, smoke, pipeline]
  mlflow_experiment: RCC_SSL
  outputs_layout: v2
  validate: { paths: true, steps_per_epoch: true, batch_sizes: true }
  allow_cpu: true

data:
  sampler:
    limit_per_epoch: 128
  img_size: 224
  webdataset:
    dataset_key: rcc_final_ablation
    shuffle_shards: 64
    shuffle_samples: 2000
    prefetch_factor: 2
    batch_size_ssl: 64
    batch_size_sl: 64
    num_workers: 4
    class_to_id: { ccRCC: 0, pRCC: 1, CHROMO: 2, ONCO: 3, NOT_TUMOR: 4 }

model:
  backbone:
    name: vit_small_patch16_224
    patch_size: 16
  ssl:
    # Valori "safe" comuni; ogni run sotto fa override di 'name' e, se serve, di altri campi
    name: dino_v3
    temperature: 0.2
    hidden_dim: 4096
    proj_dim: 256
    use_multicrop: false
    temp_teacher_schedule: null
    ema_to_one: true
    clip_qk: null
    sync_bn: false
    aug:
      jitter: 0.4
      blur_prob: 0.1
      gray_prob: 0.2
      solarize_prob: 0.0

train:
  optim:
    name: adamw
    lr: 0.0003
    weight_decay: 0.05
    betas: [0.9, 0.999]
  scheduler:
    name: cosine
    T_max: null
  ssl:
    epochs: 2
    steps_per_epoch: 2
    batch_size: 64
    accumulate_steps: 1
    num_workers: 4
    ema_momentum: 0.996
    amp: true
    grad_clip_max: 1.0
    probe:
      enabled: true
      epochs: 2
      lr: 0.05
      weight_decay: 0.0
      batch_size: 512

aug:
  base:
    rotate90: true
    hflip: true
    vflip: true
    random_resized_crop: { scale: [0.6, 1.0], ratio: [0.75, 1.33] }
    gaussian_blur_p: 0.2
    sharpen_p: 0.2
    jpeg_artifacts_p: 0.1
  stain:
    normalize: { enable: false, method: macenko }
    jitter: { enable: true, mode: HED, delta: 0.02 }
  mixing:
    mixup:  { enable: true,  alpha: 0.3 }
    cutmix: { enable: true,  beta: 1.0, p: 0.5 }

multiscale:
  enable: true
  scales: [1.0, 1.5, 2.0]
  n_per_scale: 1

sampler:
  tissue_aware: { enable: true, min_tissue_frac: 0.6 }

logging:
  log_every_steps: 10
  metrics_csv_name: ssl_timeseries.csv
  smoothing_window: 100

artifacts:
  save_best_model: true
  save_ckpt_every: 1
  export_csv: ["metrics"]
  report_md: true

# ---- Run di smoke (uno per modello SSL) ----
runs:
  - name: "smoke_dino_v3_vit_s16"
    mode: "ssl"
    override:
      model:
        ssl:
          name: "dino_v3"
          # minimi per iBOT-style views non necessari qui; niente multicrop
      train:
        ssl:
          epochs: 2
          steps_per_epoch: 2
          accumulate_steps: 1
          probe: { epochs: 2 }

  - name: "smoke_moco_v3_vit_s16"
    mode: "ssl"
    override:
      model:
        ssl:
          name: "moco_v3"
          clip_qk: 50.0      # valore sicuro per stabilitÃ  numerica in smoke
      train:
        ssl:
          epochs: 2
          steps_per_epoch: 2
          accumulate_steps: 1
          probe: { epochs: 2 }

  - name: "smoke_ibot_vit_s16"
    mode: "ssl"
    override:
      model:
        ssl:
          name: "ibot"
          num_prototypes: 8192
          temp_student: 0.10
          temp_teacher: 0.07
          use_multicrop: false
      train:
        ssl:
          epochs: 2
          steps_per_epoch: 2
          accumulate_steps: 1
          probe: { epochs: 2 }

  - name: "smoke_i_jepa_vit_s16"
    mode: "ssl"
    override:
      model:
        ssl:
          name: "i_jepa"
          prediction_space: "global_mean"
          ema_to_one: true
          jepa:
            context: { scale: [0.85, 1.0], aspect_ratio: [0.9, 1.1] }
            target:  { n: 2, scale: [0.15, 0.20], aspect_ratio: [0.75, 1.5], no_overlap: true }
      train:
        ssl:
          epochs: 2
          steps_per_epoch: 2
          accumulate_steps: 1
          probe: { epochs: 2 }
