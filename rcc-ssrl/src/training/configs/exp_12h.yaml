experiment:
  name: "exp12h_rcc_ssl"
  date: "2025-10-29"
  seed: 1337
  paper_tags: ["12h","vit_s16","histopath_aug","moco_v3","ibot","dino_v3","ijepa"]
  mlflow_experiment: "RCC_EXP12H"
  validate: { paths: true, steps_per_epoch: true, batch_sizes: true }
  allow_cpu: false

data:
  img_size: 224
  dino_v3: { global_size: 224, local_size: 96, n_local: 8 }   # multi-crop qui
  webdataset:
    dataset_key: "rcc_v2"
    shuffle_shards: 100
    shuffle_samples: 3000
    prefetch_factor: 4
    batch_size_ssl: 32            # DINOv3 override a 16 sotto
    batch_size_sl: 64
    num_workers: 8
    # opzionale: abilita derivazione automatica degli step se non setti steps_per_epoch
    # samples_per_epoch: 32000
    class_to_id: { ccRCC: 0, pRCC: 1, CHROMO: 2, ONCO: 3, NOT_TUMOR: 4 }

train:
  optim: { name: "adamw", lr: 0.0008, weight_decay: 0.05, betas: [0.9, 0.999] }
  scheduler: { name: "cosine" }          # T_max derivato (SSL=steps totali, SL=epochs)
  ssl:
    epochs: 8
    steps_per_epoch: 1500                # ~12k step totali (budget 12h). In alternativa usa samples_per_epoch.
    ema_m: 0.98                          # <-- EMA su log-loss (smoothing logging), non teacher momentum!
    probe: { enabled: true, epochs: 10, lr: 0.01, weight_decay: 0.0, batch_size: 256 }
  sl:
    epochs: 10
    amp: true
    do_val: true
    do_test: false

logging:
  log_every_steps: 50
  metrics_csv_name: "ssl_timeseries.csv"
  smoothing_window: 50

artifacts:
  save_best_model: true
  save_ckpt_every: 1
  export_csv: ["metrics"]
  report_md: true

runs:
  # ---- SSL (4 modelli) ----
  - name: "moco_v3_r50_12k"
    mode: "ssl"
    override:
      model:
        backbone: "resnet50"
        ssl: { name: "moco_v3", temperature: 0.2, proj_dim: 256 }
      train: { ssl: { steps_per_epoch: 1500, epochs: 8 } }

  - name: "ibot_vit_s16_12k"
    mode: "ssl"
    override:
      model:
        backbone: "vit_s16"
        ssl:
          name: "ibot"
          mask_ratio: 0.5
          prototypes: 8192
          sinkhorn_iters: 5
          temp_teacher: { start: 0.04, end: 0.07 }   # schedule definito sotto (C)
          temp_student: { start: 0.10, end: 0.20 }
          momentum:     { start: 0.996, end: 0.999 } # teacher EMA schedule
      train: { ssl: { steps_per_epoch: 1500, epochs: 8 } }

  - name: "dino_v3_vit_s16_mc_12k"
    mode: "ssl"
    override:
      model:
        backbone: "vit_s16"
        ssl:
          name: "dino_v3"
          gram_lambda: 1.0
          temp_teacher: { start: 0.04, end: 0.07 }
          temp_student: { start: 0.10, end: 0.20 }
          momentum:     { start: 0.996, end: 0.999 }
      data:
        webdataset: { batch_size_ssl: 16 }           # piÃ¹ leggero per multi-crop
        dino_v3:    { global_size: 224, local_size: 96, n_local: 8 }
      train: { ssl: { steps_per_epoch: 1500, epochs: 8 } }

  - name: "ijepa_vit_s16_12k"
    mode: "ssl"
    override:
      model:
        backbone: "vit_s16"
        ssl:
          name: "i_jepa"
          context_scale: 0.6
          targets_per_image: 4
          target_scales: [0.1, 0.4]
      train: { ssl: { steps_per_epoch: 1500, epochs: 8 } }
