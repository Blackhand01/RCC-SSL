# configs/experiment_18h.yaml
experiment:
  name: "exp18h_rcc_cls_full"
  date: "2025-10-29"
  seed: 1337
  default_run_index: -1
  paper_tags: ["18h","moco_v3","dino_v3","ibot","ijepa","sl_resnet"]
  mlflow_experiment: "RCC_EXP18H"
  outputs_layout: "v2"
  validate: { paths: true, steps_per_epoch: true, batch_sizes: true }
  allow_cpu: false

data:
  img_size: 224
  webdataset:
    dataset_key: "rcc_v2"          # risolto da utils/paths.py
    shuffle_shards: 100
    shuffle_samples: 4000
    prefetch_factor: 4
    batch_size_ssl: 64              # world_size=8 → global_batch_ssl=512
    batch_size_sl: 64               # world_size=8 → global_batch_sl=512
    num_workers: 8
    class_to_id: { ccRCC: 0, pRCC: 1, CHROMO: 2, ONCO: 3, NOT_TUMOR: 4 }

dino_v3:
  global_size: 224
  local_size: 96
  n_local: 2

train:
  # Nota: LR leggermente più basso per stabilità SSL (evita divergenze/inf loss)
  optim: { name: "adamw", lr: 0.0003, weight_decay: 0.05, betas: [0.9, 0.999] }
  scheduler: { name: "cosine", T_max: 6 }   # sovrascritto se necessario nei singoli run
  ssl:
    epochs: 6                  # ~3h per modello con ~1500 step/epoca ⇒ ~12h totali SSL
    steps_per_epoch: 1500
    ema_momentum: 0.996
    probe:
      enabled: true
      epochs: 20
      lr: 0.01
      weight_decay: 0.0
      batch_size: 256
  sl:
    epochs: 20                 # ~1–1.5h per modello ⇒ ~2–3h totali SL
    early_stop_patience: 5
    amp: true
    do_val: true
    do_test: false

logging:
  log_every_steps: 1
  metrics_csv_name: "timeseries_metrics.csv"

xai: { methods: [] }

artifacts:
  save_best_model: true
  save_ckpt_every: 1
  export_csv: ["metrics"]
  report_md: true

runs:

  # ---------------- SL (supervised) ----------------
  # 120 step/epoca: 120 * 512 = 61_440 campioni/epoca
  - name: "r50_scratch_18h"
    mode: "sl"
    override:
      model:
        sl: { name: "resnet50_scratch", num_classes: 5, dropout_p: 0.0 }
      data:
        webdataset: { samples_per_epoch: 61440 }
      train:
        sl: { epochs: 20, amp: true, do_val: true, do_test: false }
        scheduler: { name: "cosine", T_max: 20 }

  - name: "r50_transfer_18h"
    mode: "sl"
    override:
      model:
        sl:
          name: "resnet50_transfer"
          num_classes: 5
          imagenet_weights: "DEFAULT"
          freeze_backbone: false
          bn_eval_freeze: false
          dropout_p: 0.0
      data:
        webdataset: { samples_per_epoch: 61440 }
      train:
        sl: { epochs: 20, amp: true, do_val: true, do_test: false }
        scheduler: { name: "cosine", T_max: 20 }

  # ---------------- SSL (self-supervised) ----------------
  # Config pensata per evitare loss=inf e garantire salvataggio __ssl_best.pt via probe
  - name: "moco_v3_18h"
    mode: "ssl"
    override:
      model:
        ssl: { name: "moco_v3", temperature: 0.2, proj_dim: 256 }
      train:
        ssl: { epochs: 6, steps_per_epoch: 1500 }

  - name: "ibot_18h"
    mode: "ssl"
    override:
      model:
        ssl:
          name: "ibot"
          mask_ratio: 0.4
          prototypes: 1024
          temp_teacher: 0.1
          temp_student: 0.2
      train:
        ssl: { epochs: 6, steps_per_epoch: 1500 }

  - name: "i_jepa_18h"
    mode: "ssl"
    override:
      model:
        ssl:
          name: "i_jepa"
          context_scale: 0.6
          targets_per_image: 2
          target_scales: [0.1, 0.4]
      train:
        ssl: { epochs: 6, steps_per_epoch: 1500 }

  - name: "dino_v3_18h"
    mode: "ssl"
    override:
      model:
        ssl:
          name: "dino_v3"
          temp_teacher: 0.07
          temp_student: 0.1
          gram_lambda: 1.0
      data:
        dino_v3: { global_size: 224, local_size: 96, n_local: 2 }
      train:
        ssl: { epochs: 6, steps_per_epoch: 1500 }
