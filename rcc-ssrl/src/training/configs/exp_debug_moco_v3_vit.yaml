experiment:
  name: "exp_debug_moco_v3_vit_v2"
  date: "2025-11-05"
  seed: 1337
  default_run_index: 0
  paper_tags: ["debug","ssl_focus","moco_v3","vit","linear_probe"]
  mlflow_experiment: "RCC_DEBUG"
  outputs_layout: "v2"
  validate: { paths: true, steps_per_epoch: true, batch_sizes: true }
  allow_cpu: false

data:
  img_size: 224
  webdataset:
    dataset_key: "rcc_v2"
    shuffle_shards: 64
    shuffle_samples: 2000
    prefetch_factor: 2
    batch_size_ssl: 64
    batch_size_sl: 64
    num_workers: 8
    class_to_id: { ccRCC: 0, pRCC: 1, CHROMO: 2, ONCO: 3, NOT_TUMOR: 4 }

model:
  backbone: "vit_base_patch16_224"
  backbone_opts:
    freeze_patch_embed: false      # <— sbloccato
    random_patch_proj: false
    bn_in_patch: true
  ssl:
    name: "moco_v3"
    temperature: 0.2
    proj_dim: 256
    hidden_dim: 4096
    use_multicrop: false
    clip_qk: 50.0
    ema_to_one: true
    sync_bn: false
    aug:
      jitter: 0.4
      blur_prob: 0.1
      gray_prob: 0.2
      solarize_prob: 0.0

train:
  optim:
    name: "adamw"
    lr: 0.0003
    weight_decay: 0.05
    betas: [0.9, 0.999]
  scheduler:
    name: "cosine"
    T_max: 1200                 # 2 epoche × 600 step
  ssl:
    epochs: 2
    steps_per_epoch: 600
    ema_momentum: 0.997         # <— leggero boost di stabilità
    amp: true
    grad_clip: 1.0
    grad_clip_max: 1.0
    accumulate_steps: 16
    probe:
      enabled: true
      epochs: 40                # <— più tempo al lineare
      lr: 0.05                  # <— più “aggressivo” con AdamW
      weight_decay: 0.0
      batch_size: 512

# ---- NUOVI TOGGLE (top-level, nessun nuovo file) ----
aug:
  base:
    rotate90: true
    hflip: true
    vflip: true
    random_resized_crop: { scale: [0.6, 1.0], ratio: [0.75, 1.33] }
    gaussian_blur_p: 0.2
    sharpen_p: 0.2
    jpeg_artifacts_p: 0.1
  stain:
    normalize: { enable: false, method: "macenko" }   # true se libreria disponibile
    jitter:     { enable: true,  mode: "HED", delta: 0.02 }
  mixing:
    mixup:  { enable: true,  alpha: 0.3 }
    cutmix: { enable: true,  beta: 1.0, p: 0.5 }
multiscale:
  enable: true
  scales: [1.0, 1.5, 2.0]
  n_per_scale: 1
sampler:
  tissue_aware: { enable: true, min_tissue_frac: 0.6 }
eval:
  tta: { enable: true, rotations: [0,90,180,270], flips: [h,v] }
  sl:
    epochs: 0                   # niente SL full in debug
    early_stop_patience: 5
    amp: true
    do_val: true
    do_test: false

logging:
  log_every_steps: 10
  metrics_csv_name: "ssl_timeseries.csv"
  smoothing_window: 100

xai: { methods: [] }

artifacts:
  save_best_model: true
  save_ckpt_every: 1
  export_csv: ["metrics"]
  report_md: true

runs:
  - name: "moco_v3_vit_b16_debug_v2"
    mode: "ssl"
    override:
      model:
        ssl:
          name: "moco_v3"
          temperature: 0.2
          proj_dim: 256
          hidden_dim: 4096
          use_multicrop: false
          clip_qk: 50.0
      train:
        ssl:
          epochs: 2
          steps_per_epoch: 600
          accumulate_steps: 16
          ema_momentum: 0.997
          grad_clip: 1.0
          grad_clip_max: 1.0
          probe:
            epochs: 40
            lr: 0.05
            weight_decay: 0.0
            batch_size: 512
