experiment:
  name: "exp_moco_v3_vit"
  date: "2025-11-05"
  seed: 1337
  default_run_index: 0
  paper_tags: ["10ep","ssl_focus","moco_v3","vit","linear_probe"]
  mlflow_experiment: "RCC_MOCO_V3_VIT"
  outputs_layout: "v2"
  validate: { paths: true, steps_per_epoch: true, batch_sizes: true }
  allow_cpu: false

data:
  img_size: 224
  webdataset:
    dataset_key: "rcc_v2"
    shuffle_shards: 128
    shuffle_samples: 4000
    prefetch_factor: 4
    batch_size_ssl: 128
    batch_size_sl: 64
    num_workers: 8
    class_to_id: { ccRCC: 0, pRCC: 1, CHROMO: 2, ONCO: 3, NOT_TUMOR: 4 }

model:
  backbone: "vit_base_patch16_224"
  backbone_opts:
    freeze_patch_embed: true
    random_patch_proj: false
    bn_in_patch: true
  ssl:
    name: "moco_v3"
    temperature: 0.2
    proj_dim: 256
    hidden_dim: 4096
    use_multicrop: false
    clip_qk: 50.0
    ema_to_one: true
    sync_bn: true                  # usato solo se DDP è inizializzato
    temp_teacher_schedule:         # warmup breve della T del teacher
      start: 0.1
      end: 0.2
      warmup_frac: 0.05
    aug:
      jitter: 0.4
      blur_prob: 0.1
      gray_prob: 0.2
      solarize_prob: 0.0

train:
  optim:
    name: "adamw"
    lr: 0.0003                     # stabile per 10 epoche con batch 128
    weight_decay: 0.05
    betas: [0.9, 0.999]
  scheduler:
    name: "cosine"
    T_max: 44050                   # 10 epoche × 4405 step/epoca
  ssl:
    epochs: 10
    steps_per_epoch: 4405
    ema_momentum: 0.99             # tuning consigliato per ViT-B
    amp: true
    grad_clip: 1.0
    grad_clip_max: 1.0
    accumulate_steps: 32
    probe:
      enabled: true
      epochs: 40
      lr: 0.02                     # più conservativo del debug (AdamW)
      weight_decay: 0.0
      batch_size: 512

# ---- TOGGLE (top-level) ----
aug:
  base:
    rotate90: true
    hflip: true
    vflip: true
    random_resized_crop: { scale: [0.6, 1.0], ratio: [0.75, 1.33] }
    gaussian_blur_p: 0.2
    sharpen_p: 0.2
    jpeg_artifacts_p: 0.1
  stain:
    normalize: { enable: false, method: "macenko" }   # metti true se libreria pronta
    jitter:     { enable: true,  mode: "HED", delta: 0.02 }
  mixing:
    mixup:  { enable: true,  alpha: 0.3 }
    cutmix: { enable: true,  beta: 1.0, p: 0.5 }

multiscale:
  enable: true
  scales: [1.0, 1.5, 2.0]
  n_per_scale: 1

sampler:
  tissue_aware: { enable: true, min_tissue_frac: 0.6 }

eval:
  tta: { enable: true, rotations: [0,90,180,270], flips: [h,v] }
  sl:
    epochs: 30
    early_stop_patience: 7
    amp: true
    do_val: true
    do_test: false

logging:
  log_every_steps: 1000
  metrics_csv_name: "ssl_timeseries.csv"
  smoothing_window: 100

xai: { methods: [] }

artifacts:
  save_best_model: true
  save_ckpt_every: 1
  export_csv: ["metrics"]
  report_md: true

runs:
  - name: "moco_v3_vit_b16_10ep"
    mode: "ssl"
    override:
      model:
        ssl:
          name: "moco_v3"
          temperature: 0.2
          proj_dim: 256
          hidden_dim: 4096
          use_multicrop: false
          clip_qk: 50.0
          sync_bn: true
          temp_teacher_schedule: { start: 0.1, end: 0.2, warmup_frac: 0.05 }
      train:
        ssl:
          epochs: 10
          steps_per_epoch: 4405
          accumulate_steps: 32
          ema_momentum: 0.99
          grad_clip: 1.0
          grad_clip_max: 1.0
          probe:
            epochs: 40
            lr: 0.02
            weight_decay: 0.0
            batch_size: 512
