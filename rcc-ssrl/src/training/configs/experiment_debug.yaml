# configs/experiment_debug.yaml
experiment:
  name: "debug_ssl_sl_smoke"
  date: "2025-10-30"
  seed: 1337
  default_run_index: -1
  paper_tags: ["debug","smoke","ssl_focus"]
  mlflow_experiment: "RCC_DEBUG"
  outputs_layout: "v2"
  validate: { paths: true, steps_per_epoch: true, batch_sizes: true }
  allow_cpu: true

data:
  img_size: 224
  webdataset:
    dataset_key: "rcc_v2"
    shuffle_shards: 16
    shuffle_samples: 512
    prefetch_factor: 2
    batch_size_ssl: 32
    batch_size_sl: 32
    num_workers: 2
    class_to_id: { ccRCC: 0, pRCC: 1, CHROMO: 2, ONCO: 3, NOT_TUMOR: 4 }

dino_v3:
  global_size: 224
  local_size: 96
  n_local: 2
  jitter: 0.4
  global_scale: [0.14, 1.0]
  local_scale: [0.05, 0.14]
  blur_prob: 0.5
  solarize_prob: 0.1

train:
  optim: { name: "adamw", lr: 0.0003, weight_decay: 0.05, betas: [0.9, 0.999] }
  scheduler: { name: "cosine", T_max: 2 }

  ssl:
    epochs: 2
    steps_per_epoch: 10         # ~pochi minuti per run
    ema_momentum: 0.996
    amp: true
    grad_clip: 1.0
    probe:
      enabled: true
      epochs: 3
      lr: 0.01
      weight_decay: 0.0
      batch_size: 128

  sl:
    epochs: 2
    early_stop_patience: 1
    amp: true
    do_val: true
    do_test: false

logging:
  log_every_steps: 2
  metrics_csv_name: "timeseries_metrics.csv"

xai: { methods: [] }

artifacts:
  save_best_model: true
  save_ckpt_every: 1
  export_csv: ["metrics"]
  report_md: true

runs:

  # ---- SSL (smoke) ----
  - name: "moco_v3_debug"
    mode: "ssl"
    override:
      model:
        ssl: { name: "moco_v3", temperature: 0.2, proj_dim: 256 }
      train:
        ssl: { epochs: 2, steps_per_epoch: 10 }

  - name: "ibot_debug"
    mode: "ssl"
    override:
      model:
        ssl:
          name: "ibot"
          prototypes: 512
          temp_teacher: 0.04
          temp_student: 0.10
          mask_ratio: 0.20
          w_cls: 1.0
          w_tok: 1.0
          schedules:
            temp_teacher: { start: 0.04, end: 0.06, warmup_frac: 0.50 }
            mask_ratio:   { start: 0.00, end: 0.20, warmup_frac: 0.50 }
      train:
        ssl: { epochs: 2, steps_per_epoch: 10 }

  - name: "i_jepa_debug"
    mode: "ssl"
    override:
      model:
        ssl:
          name: "i_jepa"
          context_scale: 0.6
          targets_per_image: 2
          target_scales: [0.12, 0.35]
          min_iou_ctx: 0.05
          use_cosine_loss: true
      train:
        ssl: { epochs: 2, steps_per_epoch: 10 }

  - name: "dino_v3_debug"
    mode: "ssl"
    override:
      model:
        ssl:
          name: "dino_v3"
          temp_teacher: 0.04
          temp_student: 0.10
          gram_lambda: 1.0
          center_momentum: 0.9
          teacher_temp_schedule: { min: 0.04, max: 0.06, warmup_steps: 200 }
      data:
        dino_v3: { global_size: 224, local_size: 96, n_local: 2 }
      train:
        ssl: { epochs: 2, steps_per_epoch: 10 }

  # ---- SL (smoke) ----
  - name: "r50_scratch_debug"
    mode: "sl"
    override:
      model:
        sl: { name: "resnet50_scratch", num_classes: 5, dropout_p: 0.0 }
      data:
        webdataset: { samples_per_epoch: 512 }   # ~10 step/epoca
      train:
        sl: { epochs: 2, amp: true, do_val: true, do_test: false }
        scheduler: { name: "cosine", T_max: 2 }

  - name: "r50_transfer_debug"
    mode: "sl"
    override:
      model:
        sl:
          name: "resnet50_transfer"
          num_classes: 5
          imagenet_weights: "DEFAULT"
          freeze_backbone: true
          bn_eval_freeze: true
          dropout_p: 0.0
      data:
        webdataset: { samples_per_epoch: 512 }
      train:
        sl: { epochs: 2, amp: true, do_val: true, do_test: false }
        scheduler: { name: "cosine", T_max: 2 }
