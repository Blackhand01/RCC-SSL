# Config di base per I-JEPA (ViT-S/16), debug/ablazioni
experiment:
  name: exp_debug_i_jepa_vit
  seed: 1337
  allow_cpu: false
  validate:
    paths: true
    steps_per_epoch: true
    batch_sizes: true

data:
  img_size: 224
  webdataset:
    dataset_key: rcc_v2
    # mapping (adatta ai tuoi id reali)
    class_to_id: { ccRCC: 0, pRCC: 1, CHROMO: 2, ONCO: 3, NOT_TUMOR: 4 }
    shuffle_shards: 100
    shuffle_samples: 2000
    batch_size_ssl: 128
    batch_size_sl: 256
    num_workers: 8
    prefetch_factor: 4
    samples_per_epoch: 12800   # = 100 steps/epoch at bs=128; adjust as needed

# facoltativo: stain (disabilitato di default per JEPA)
aug:
  stain:
    normalize: { enable: false, method: macenko }
    jitter: { enable: false, delta: 0.02 }

model:
  type: ssl
  backbone: vit_small_patch16_224    # o vit_base_patch16_224 (vedi ablation)
  backbone_opts:
    freeze_patch_embed: true
  ssl:
    name: i_jepa
    targets_per_image: 4
    context_scale: 0.92         # [0.85–1.0] consigliato
    context_jitter: 0.0
    target_scales: [0.15, 0.20] # M=4 blocks ~15–20%
    no_overlap: true
    max_context_resample: 4
    min_target_tokens: 4
    ema_schedule: { min: 0.99, warmup_steps: 4000 }

train:
  optim:
    name: adamw
    lr: 3.0e-4
    weight_decay: 0.05
    betas: [0.9, 0.95]
  scheduler:
    name: cosine
  ssl:
    epochs: 10
    steps_per_epoch: 100           # 12.8k samples/epoch @ bs=128 => 100 steps
    accumulate_steps: 1
    amp: true
    grad_clip_max: 0.0
    ema_m: 0.0                   # solo EMA per JEPA teacher; questo è per log smoothing
    probe:                       # linear probe rapido post-SSL (facoltativo)
      epochs: 5
      lr: 0.01
      weight_decay: 0.0
      batch_size: 256

logging:
  log_every_steps: 20
  metrics_csv_name: ssl_timeseries.csv
  smoothing_window: 50
