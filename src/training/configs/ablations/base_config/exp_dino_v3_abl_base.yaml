experiment:
  name: exp_dino_v3_abl_new03
  date: '2025-12-08'
  seed: 1337
  default_run_index: -1
  paper_tags:
  - ssl
  - histopathology
  - dino_v3_histopathology_ablations
  - dino_v3
  - ablation
  - multicrop
  - 2g6l
  - local_scale_[0.05,0.12]
  mlflow_experiment: RCC_SSL
  outputs_layout: v2
  validate:
    paths: true
    steps_per_epoch: true
    batch_sizes: true
  allow_cpu: true
data:
  sampler:
    shardshuffle: true
    resampled: true
    limit_per_epoch: null
  img_size: 224
  webdataset:
    dataset_key: rcc_final_ablation
    shuffle_shards: 64
    shuffle_samples: 2000
    prefetch_factor: 4
    persistent_workers: true
    pin_memory: true
    batch_size_ssl: 64
    batch_size_sl: 64
    num_workers: 8
    class_to_id:
      ccRCC: 0
      pRCC: 1
      CHROMO: 2
      ONCO: 3
      NOT_TUMOR: 4
  dino_v3:
    global_size: 224
    local_size: 96
    n_local: 6
    jitter: 0.4
    global_scale:
    - 0.14
    - 1.0
    local_scale:
    - 0.05
    - 0.12
    blur_prob: 0.3
    solarize_prob: 0.02
model:
  backbone:
    name: vit_small_patch16_224
    patch_size: 16
  model:
  backbone:
    name: vit_small_patch16_224
    patch_size: 16

  ssl:
    name: dino_v3

    # --- DINOv3 head dimensions ---
    head_hidden_dim: 4096        # hidden_dim MLP
    head_bottleneck_dim: 256     # bottleneck_dim
    head_n_prototypes: 8192     # nÂ° prototipi (output dim); puoi ridurre (es. 8192) se memoria critica

    use_multicrop: true

    # --- Temperature (nomi devono combaciare col codice) ---
    student_temp: 0.1
    teacher_temp: 0.04

    # --- Pesi delle loss ---
    loss_weight: 1.0          # peso loss DINO (CLS)
    ibot_loss_weight: 1.0     # peso iBOT patch loss
    koleo_loss_weight: 0.1    # peso KoLeo

    # ---- Gram refinement ----
    gram:
      lambda: 1.0
      start_frac: 0.7
      teacher_update_every: 10000
      teacher_updates_max: 3

    # Queste chiavi qui sotto ATTUALMENTE non sono usate dal tuo DINOv3
    # (le puoi lasciare o togliere, non fanno danno, ma sono "decorative")
    ema_to_one: true
    clip_qk: null
    sync_bn: false
    aug:
      jitter: 0.4
      blur_prob: 0.1
      gray_prob: 0.2
      solarize_prob: 0.0

train:
  optim:
    name: adamw
    lr: 0.0003
    weight_decay: 0.05
    betas:
    - 0.9
    - 0.999
  scheduler:
    name: cosine
    T_max: null
  ssl:
    epochs: 25
    steps_per_epoch: 4450
    checkpoint:
      metric: probe_val_acc  # ssl_loss | final_epoch | probe_val_acc | ssl_loss_after_warmup
      warmup_epochs: 2              # usato solo per *_after_warmup / probe_val_acc
      eval_every_epochs: 1          # per probe_val_acc: frequenza di valutazione
      probe_epochs: 15
    batch_size: 64
    accumulate_steps: 16
    num_workers: 8
    ema_momentum: 0.996
    amp: true
    grad_clip_max: 1.0
    probe:
      enabled: true
      epochs: 50
      lr: 0.05
      weight_decay: 0.0
      batch_size: 512
aug:
  base:
    rotate90: true
    hflip: true
    vflip: true
    random_resized_crop:
      scale:
      - 0.6
      - 1.0
      ratio:
      - 0.75
      - 1.33
    gaussian_blur_p: 0.2
    sharpen_p: 0.2
    jpeg_artifacts_p: 0.1
  stain:
    normalize:
      enable: false
      method: macenko
    jitter:
      enable: true
      mode: HED
      delta: 0.02
  mixing:
    mixup:
      enable: true
      alpha: 0.3
    cutmix:
      enable: true
      beta: 1.0
      p: 0.5
multiscale:
  enable: true
  scales:
  - 1.0
  - 1.5
  - 2.0
  n_per_scale: 1
sampler:
  tissue_aware:
    enable: true
    min_tissue_frac: 0.6
logging:
  log_every_steps: 10
  metrics_csv_name: ssl_timeseries.csv
  smoothing_window: 100
artifacts:
  save_best_model: true
  save_ckpt_every: 1
  export_csv:
  - metrics
  report_md: true
